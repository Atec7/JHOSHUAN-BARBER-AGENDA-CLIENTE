<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agendamento - Barbearia</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
/* Reset e base */
    *, *::before, *::after {
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #121212;
      color: #fff;
      margin: 0; padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-bottom: 40px;
    }
    header {
      text-align:center;
      background: #000;
      padding: 20px;
      width: 100%;
      max-width: 480px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 16px;
      font-weight: 300;
      color: #FFD700;
      letter-spacing: 2px;
      user-select: none;
      box-shadow: 0 2px 8px rgba(255, 215, 0, 0.5);
    }
    #logo {
      border-radius:50%;
      width: 40px;
      height: 40px;
      object-fit: contain;
    }
    main.container {
      width: 100%;
      max-width: 480px;
      padding: 20px;
      background: #1f1f1f;
      border-radius: 12px;
      margin-top: 20px;
      box-shadow: 0 0 15px #FFD700aa;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    #servicos {
      display: flex;
      flex-direction: column;
      gap: 14px;
      max-height: 320px;
      overflow-y: auto;
      padding-right: 8px;
      outline: none;
    }
    .servico {
      background: #2a2a2a;
      border-radius: 12px;
      padding: 12px;
      display: flex;
      align-items: center;
      cursor: pointer;
      user-select: none;
      border: 2px solid transparent;
      transition: background-color 0.3s, border-color 0.3s;
    }
    .servico:hover {
      background: #393939;
      border-color: #FFD700;
    }
    .servico input[type="radio"] {
      margin-right: 14px;
      accent-color: #FFD700;
      width: 20px;
      height: 20px;
      cursor: pointer;
      flex-shrink: 0;
    }
    .servico img {
      width: 70px;
      height: 70px;
      border-radius: 10px;
      object-fit: cover;
      margin-right: 14px;
      flex-shrink: 0;
      box-shadow: 0 0 6px #FFD700aa;
      transition: transform 0.3s;
    }
    .servico:hover img {
      transform: scale(1.05);
    }
    .servico div {
      flex: 1;
    }
    .servico strong {
      font-size: 1.1rem;
      margin-bottom: 6px;
      display: block;
    }
    .servico small {
      font-size: 0.85rem;
      color: #ccc;
    }
    .form-group {
      display: flex;
      flex-direction: column;
    }
    label {
      margin-bottom: 6px;
      font-weight: 600;
    }
    input[type="text"],
    input[type="date"],
    select {
      background-color: #2a2a2a;
      border: none;
      border-radius: 8px;
      color: #fff;
      font-size: 1rem;
      padding: 12px 16px;
      transition: box-shadow 0.3s ease, background-color 0.3s ease;
    }
    input[type="text"]:focus,
    input[type="date"]:focus,
    select:focus {
      outline: none;
      box-shadow: 0 0 8px #FFD700;
      background-color: #3b3b3b;
    }
    select {
      appearance: none;
      -webkit-appearance: none;
      background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20width%3D'12'%20height%3D'12'%20viewBox%3D'0%200%2012%2012'%20xmlns%3D'http%3A//www.w3.org/2000/svg'%3E%3Cpath%20d%3D'M2%204l4%204%204-4'%20stroke%3D'%23FFD700'%20stroke-width%3D'2'%20fill%3D'none'%20fill-rule%3D'evenodd'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 12px 12px;
      padding-right: 36px;
      cursor: pointer;
    }
    button {
      width:100%;
      background-color: #FFD700;
      border: none;
      border-radius: 10px;
      font-weight: 900;
      color: #121212;
      font-size: 1.2rem;
      padding: 14px;
      cursor: pointer;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
      box-shadow: 0 4px 12px #FFD700cc;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    button:hover:not(:disabled) {
      background-color: #e6c200;
      box-shadow: 0 6px 14px #e6c200cc;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
    }
    .spinner {
      border: 4px solid #2a2a2a;
      border-top: 4px solid #FFD700;
      border-radius: 50%;
      width: 26px;
      height: 26px;
      animation: spin 1s linear infinite;
      display: inline-block;
      vertical-align: middle;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    #msgStatus {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #272727dd;
      color: #FFD700;
      padding: 12px 24px;
      border-radius: 24px;
      font-weight: 700;
      font-size: 1rem;
      box-shadow: 0 0 12px #FFD700cc;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 9999;
    }
    #msgStatus.show {
      opacity: 1;
      pointer-events: auto;
    }
    @media (max-width: 520px) {
      header {
        font-size: 1.5rem;
        padding: 16px;
      }
      main.container {
        padding: 16px;
      }
      .servico img {
        width: 55px;
        height: 55px;
      }
      button {
        font-size: 1rem;
        padding: 12px;
      }
    }

    /* Tela de carregamento (splash) */
    #splash {
      position: fixed;
      inset: 0;
      background-color: #121212;
      color: #FFD700;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      user-select: none;
    }
    #splash img {
      border-radius: 50%;
      width: 220px;
      height: auto;
      margin-bottom: 20px;
      filter: drop-shadow(0 0 5px #FFD700);
    }
    #splash h1 {
      font-size: 2.5rem;
      font-weight: 100;
      letter-spacing: 3px;
      margin-bottom: 30px;
      text-align: center;
      text-shadow: 0 0 10px #FFD700;
    }
    #progressBarContainer {
      width: 70%;
      max-width: 400px;
      height: 14px;
      background-color: #2a2a2a;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 0 10px #FFD700cc inset;
    }
    #progressBar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #FFD700, #e6c200);
      border-radius: 10px;
      transition: width 0.1s ease;
      box-shadow: 0 0 8px #FFD700;
    }
    .titulo{
      font-size:16px;
    }
  </style>
</head>
<body>
  <div id="splash">
    <img src="logo.jpg" alt="Logo da Barbearia" />
    <h1>JHOSHUAN BARBER SHOP</h1>
    <div id="progressBarContainer">
      <div id="progressBar"></div>
    </div>
    <p>www.atecseven.com.br</p>
  </div>

  <header><img src="logo.jpg" alt="Logo da Barbearia" id="logo" />
    <h1 class="titulo">JHOSHUAN BARBER SHOP</h1></header>
  <main class="container" style="display:none;">
    <form id="formAgendamento" novalidate>
      <div id="servicos"></div>

      <div class="form-group">
        <label for="nome">Seu nome:</label>
        <input type="text" id="nome" name="nome" placeholder="Digite seu nome completo" required minlength="3" />
      </div>

      <div class="form-group">
        <label for="whatsapp">WhatsApp:</label>
        <input type="text" id="whatsapp" name="whatsapp" placeholder="Digite seu número de WhatsApp" />
      </div>

      <div class="form-group">
        <label for="dataAgendamento">Data do agendamento:</label>
        <input type="date" id="dataAgendamento" name="dataAgendamento" required />
      </div>

      <div class="form-group">
        <label for="horaAgendamento">Horário disponível:</label>
        <select id="horaAgendamento" name="horaAgendamento" required>
          <option value="">Selecione uma data primeiro</option>
        </select>
      </div>
      <br><br>
      <button type="submit" id="btnAgendar">Agendar <i class="fa-solid fa-calendar-check"></i></button>
    </form>
  </main>

  <div id="msgStatus"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
    import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAEtxmBU7vqhR7w1VSi9_QNJQOCmZhNkPA",
      authDomain: "babearia-jhosuan.firebaseapp.com",
      databaseURL: "https://babearia-jhosuan-default-rtdb.firebaseio.com/",
      projectId: "babearia-jhosuan",
      storageBucket: "babearia-jhosuan.appspot.com",
      messagingSenderId: "342615273720",
      appId: "1:342615273720:web:7d78eb757acf64f3ff149f",
      measurementId: "G-DEH0MNFLQF"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const servicosDiv = document.getElementById("servicos");
    const form = document.getElementById("formAgendamento");
    const btnAgendar = document.getElementById("btnAgendar");
    const msgStatus = document.getElementById("msgStatus");
    const campoData = document.getElementById("dataAgendamento");
    const campoHora = document.getElementById("horaAgendamento");

    let servicosDados = {};

    function showMessage(msg, isError = false) {
      msgStatus.textContent = msg;
      msgStatus.style.backgroundColor = isError ? '#7a1e1edd' : '#272727dd';
      msgStatus.classList.add('show');
      setTimeout(() => msgStatus.classList.remove('show'), 4000);
    }

    function gerarTodosHorarios() {
      const horarios = [];
      const inicio = new Date();
      inicio.setHours(9, 0, 0, 0);
      const fim = new Date();
      fim.setHours(21, 0, 0, 0);

      let atual = new Date(inicio);
      while (atual < fim) {
        const h = atual.getHours().toString().padStart(2, '0');
        const m = atual.getMinutes().toString().padStart(2, '0');
        horarios.push(`${h}:${m}`);
        atual = new Date(atual.getTime() + 10 * 60000);
      }
      return horarios;
    }

    function validarHorario(horarioISO) {
  if (!horarioISO || !horarioISO.includes('T')) return false;

  const [dataStr, horaStr] = horarioISO.split('T');
  if (!dataStr || !horaStr) return false;

  const [hora, minuto] = horaStr.split(':').map(Number);
  const [ano, mes, dia] = dataStr.split('-').map(Number);

  const agendamento = new Date(ano, mes - 1, dia, hora, minuto);
  const agora = new Date();

  // Verifica se a data é válida
  if (isNaN(agendamento.getTime())) return false;

  // Verifica se a data está no passado
  if (agendamento <= agora) return false;

  // Verifica se está dentro do horário de atendimento (09:00 às 21:00)
  const horarioValido = (hora > 9 || (hora === 9 && minuto >= 0)) &&
                        (hora < 21 || (hora === 21 && minuto === 0));

  return horarioValido;
}



    function atualizarHorariosDisponiveis(dataISO) {
      campoHora.innerHTML = '<option value="">Carregando...</option>';
      const dia = dataISO;
      const servicoInput = form.querySelector('input[name="servico"]:checked');
      if (!servicoInput) {
        campoHora.innerHTML = '<option value="">Selecione um serviço primeiro</option>';
        return;
      }

      const duracao = servicosDados[servicoInput.value]?.tempo || 0;
      const todos = gerarTodosHorarios();

      onValue(ref(db, 'agendamentos'), (snapshot) => {
        const ocupados = [];
        snapshot.forEach(child => {
          const ag = child.val();
          const dataAg = new Date(ag.horario);
          if (dataAg.toISOString().split('T')[0] === dia) {
            const tempo = servicosDados[ag.servicoId]?.tempo || 0;
            ocupados.push({
              start: dataAg.getTime(),
              end: dataAg.getTime() + tempo * 60000
            });
          }
        });

        const disponiveis = todos.filter(horario => {
          const [h, m] = horario.split(':');
          const inicio = new Date(`${dia}T${h}:${m}:00`);
          const fim = new Date(inicio.getTime() + duracao * 60000);

          if (fim.getHours() > 21 || (fim.getHours() === 21 && fim.getMinutes() > 0)) return false;

          return !ocupados.some(o => (inicio < o.end && fim > o.start));
        });

        campoHora.innerHTML = disponiveis.length
          ? '<option value="">Selecione um horário</option>' + disponiveis.map(h => `<option value="${h}">${h}</option>`).join('')
          : '<option value="">Sem horários disponíveis</option>';
      }, { onlyOnce: true });
    }

    campoData.addEventListener('change', () => {
      const val = campoData.value;
      if (val) atualizarHorariosDisponiveis(val);
    });

    async function fetchServicos() {
      onValue(ref(db, 'servicos'), (snapshot) => {
        servicosDiv.innerHTML = '';
        servicosDados = {};
        snapshot.forEach(child => {
          const serv = child.val();
          servicosDados[child.key] = serv;

          const label = document.createElement('label');
          label.className = 'servico';
          const input = document.createElement('input');
          input.type = 'radio';
          input.name = 'servico';
          input.value = child.key;
          input.required = true;
          input.addEventListener('change', () => {
            if (campoData.value) atualizarHorariosDisponiveis(campoData.value);
          });

          const img = document.createElement('img');
          img.src = serv.imagem;
          img.alt = serv.nome;

          const div = document.createElement('div');
          const strong = document.createElement('strong');
          strong.textContent = serv.nome;
          const small = document.createElement('small');
          small.textContent = `R$ ${serv.preco} - ${serv.tempo} min`;
          div.appendChild(strong);
          div.appendChild(small);

          label.appendChild(input);
          label.appendChild(img);
          label.appendChild(div);
          servicosDiv.appendChild(label);
        });
      }, { onlyOnce: true });
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const nome = form.nome.value.trim();
      const whatsapp = form.whatsapp.value.trim();
      const data = campoData.value;
      const hora = campoHora.value;
      const servicoInput = form.querySelector('input[name="servico"]:checked');
      const horario = `${data}T${hora}:00`;

      if (!nome || nome.length < 3 || !validarHorario(horario) || !servicoInput || !hora) {
        showMessage('Provavelmente já passou desse horário🤔⏱.', true);
        return;
      }

      btnAgendar.disabled = true;
      btnAgendar.innerHTML = 'Agendando...';

      try {
        await push(ref(db, 'agendamentos'), {
          nome,
          whatsapp,
          horario,
          servicoId: servicoInput.value,
          status: 'Agendado',
          criadoEm: new Date().toISOString()
        });
        showMessage('Agendamento realizado com sucesso!');
        form.reset();
        campoHora.innerHTML = '<option value="">Selecione uma data primeiro</option>';
      } catch (err) {
        showMessage('Erro ao agendar: ' + err.message, true);
      } finally {
        btnAgendar.disabled = false;
        btnAgendar.innerHTML = 'Agendar <i class="fa-solid fa-calendar-check"></i>';
      }
    });

    function initSplash() {
      const splash = document.getElementById('splash');
      const progressBar = document.getElementById('progressBar');
      const container = document.querySelector('main.container');

      let start = null;
      function step(timestamp) {
        if (!start) start = timestamp;
        const elapsed = timestamp - start;
        const progress = Math.min((elapsed / 3000) * 100, 100);
        progressBar.style.width = progress + '%';
        if (elapsed < 3000) {
          requestAnimationFrame(step);
        } else {
          splash.style.display = 'none';
          container.style.display = 'flex';
        }
      }
      requestAnimationFrame(step);
    }

    fetchServicos();
    initSplash();
  </script>

</body>
</html>
